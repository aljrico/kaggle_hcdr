---
title: "Home Credit Default Risk"
output: 
  html_document:
    toc: true
  theme: cosmo
  highlight: haddock
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```



# Introduction

Home Credit strives to broaden financial inclusion for the unbanked population by providing a positive and safe borrowing experience. In order to make sure this underserved population has a positive loan experience, Home Credit makes use of a variety of alternative data--including telco and transactional information--to predict their clients' repayment abilities.

While Home Credit is currently using various statistical and machine learning methods to make these predictions, they're challenging Kagglers to help them unlock the full potential of their data. Doing so will ensure that clients capable of repayment are not rejected and that loans are given with a principal, maturity, and repayment calendar that will empower their clients to be successful.

## Data

The data is provided by Home Credit, a company dedicated to offer loans to unbanked customers. 

Lending money is a business of considerable risk. The main risk is, of course, what we call *Creadit Risk*. This is the probability of the burrower of being unable or unwilling to pay back the loan. Predicting whether or not a client will repay a loan or have difficulty is a critical business need, and Home Credit is hosting this competition on Kaggle to see what sort of models the machine learning community can develop to help them in this task.

```{r}
library(tidyverse)
library(data.table)
library(randomForest)
library(mice)
library(mlr)
library(scales)
library(waffle)
library(viridis)
library(devtools)
library(gridExtra)
devtools::install_github("aljrico/harrypotter")
library(harrypotter)

```

# Retrieving Data

Let us start taking a look at the dimensions of the data.

> Dataset | (rows, columns)

```{r}
application_train <-     fread("data/application_train.csv")
application_test <-      fread("data/application_test.csv")
bureau <-                fread("data/bureau.csv")
bureau_balance <-        fread("data/bureau_balance.csv")
credit_card_balance <-   fread("data/credit_card_balance.csv")
installments_payments <- fread("data/installments_payments.csv")
pos_cash_balance <-      fread("data/POS_CASH_balance.csv")

print(paste0("Application Train | ","(" ,  dim(application_train)[[1]], ",", dim(application_train)[[2]], ")"))
print(paste0("Bureau | ","(" ,  dim(bureau)[[1]], ",", dim(bureau)[[2]], ")"))
print(paste0("Bureau Balance | ","(" ,  dim(bureau_balance)[[1]], ",", dim(bureau_balance)[[2]], ")"))
print(paste0("Credit Card Balance | ","(" ,  dim(credit_card_balance)[[1]], ",", dim(credit_card_balance)[[2]], ")"))
print(paste0("Installments Payments | ","(" ,  dim(installments_payments)[[1]], ",", dim(installments_payments)[[2]], ")"))
print(paste0("POS CASH Balance | ","(" ,  dim(pos_cash_balance)[[1]], ",", dim(pos_cash_balance)[[2]], ")"))

l <- list(application_train,
					application_test,
					bureau,
					bureau_balance,
					credit_card_balance,
					installments_payments,
					pos_cash_balance)

f <- function(x) prod(dim(x))

names <- c("Train",
					"Test",
					"Bureau",
					"Bureau Balance",
					"Credit Card Balance",
					"Installment Payments",
					"POS Cash Balance")
dims <- sapply(l, f) %>% as.numeric()

cbind(names, dims) %>% 
	as_tibble() %>% 
	ggplot(aes(x = reorder(as.factor(names), -as.numeric(dims)), 
						 y = as.numeric(dims),
						 fill = as.numeric(dims))) +
	geom_col(colour = "black") +
	xlab("") +
	ylab("Dimension (Rows * Columns)") +
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	theme(legend.position = "none") +
	scale_fill_hp(house = "Gryffindor", direction = -1) 

rm(application_train, application_test, bureau, bureau_balance, credit_card_balance, installments_payments, pos_cash_balance)
```

# Exploratory Data Analysis (EDA)

## AMT

### AMT_CREDIT

```{r}
application_train <- fread("data/application_train.csv")


plot1 <- application_train %>% 
	ggplot(aes(x = AMT_CREDIT, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = AMT_CREDIT, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot3 <- application_train$AMT_CREDIT %>% 
	is.na() %>% 
	mean() %>% 
	as_tibble() %>% 
	mutate(x = "AMT_CREDIT",
				 y = 1 - value) %>% 
	melt() %>% 
	ggplot() +
	geom_col(aes(x = as.factor(x), y = 100*value, fill = variable), width = 0.3, colour = "black") +
	scale_fill_hp(house = "Hufflepuff", name = "", labels = c("NA", "value"), discrete = TRUE) +
	xlab("") +
	ylab("(%)") +
	ggtitle("Percentage of Missing Values") +
	theme_bw()

plot1
plot2


```

### AMT_INCOME_TOTAL

```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = AMT_INCOME_TOTAL, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = AMT_INCOME_TOTAL, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot3 <- application_train$AMT_INCOME_TOTAL %>% 
	is.na() %>% 
	mean() %>% 
	as_tibble() %>% 
	mutate(x = "AMT_CREDIT",
				 y = 1 - value) %>% 
	melt() %>% 
	ggplot() +
	geom_col(aes(x = as.factor(x), y = 100*value, fill = variable), width = 0.3, colour = "black") +
	scale_fill_hp(house = "Hufflepuff", name = "", labels = c("NA", "value"), discrete = TRUE) +
	xlab("") +
	ylab("(%)") +
	ggtitle("Percentage of Missing Values") +
	theme_bw()

plot1
plot2


```
### LOAN_INCOME_RATIO

```{r}

plot1 <- application_train %>%
	mutate(LOAN_INCOME_RATIO = AMT_CREDIT / AMT_INCOME_TOTAL) %>% 
	ggplot(aes(x = LOAN_INCOME_RATIO, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	mutate(LOAN_INCOME_RATIO = AMT_CREDIT / AMT_INCOME_TOTAL) %>% 
	ggplot(aes(x = (LOAN_INCOME_RATIO), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2

```

### LOAN_INCOME_PROD

```{r}

plot1 <- application_train %>%
	mutate(LOAN_INCOME_PROD = AMT_CREDIT * AMT_INCOME_TOTAL) %>% 
	ggplot(aes(x = LOAN_INCOME_PROD, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	mutate(LOAN_INCOME_PROD= AMT_CREDIT * AMT_INCOME_TOTAL) %>% 
	ggplot(aes(x = (LOAN_INCOME_PROD), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2

```


### AMT_GOODS_PRICE

```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = AMT_GOODS_PRICE, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = AMT_GOODS_PRICE, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2

```
### CREDIT_TO_GOODS_RATIO

```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = AMT_CREDIT / log10(AMT_GOODS_PRICE), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = (AMT_CREDIT / log10(AMT_GOODS_PRICE)), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2

```


### AMT_ANNUITY

```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = AMT_ANNUITY, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = AMT_ANNUITY, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2


```

### ANNUITY_PRESSURE

```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = log10(AMT_CREDIT) * AMT_ANNUITY, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = log10(AMT_CREDIT) * (AMT_ANNUITY), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2


```


### CNT_CHILDREN

```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = CNT_CHILDREN, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = CNT_CHILDREN, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot1
plot2
```
```{r}

plot1 <- application_train %>% 
	mutate(HAS_CHILDREN = CNT_CHILDREN > 0) %>% 
	group_by(HAS_CHILDREN, TARGET) %>% 
	summarise(n = n()) %>% 
	group_by(HAS_CHILDREN) %>% 
	mutate(prop = n/sum(n)) %>% 
	ggplot(aes(x = HAS_CHILDREN, fill = as.factor(TARGET))) +
	geom_col(aes(y = prop), colour = "black") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	ylab("Proportion") +
	theme_bw()

plot1
```


### INC_PER_CHILD
```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = AMT_INCOME_TOTAL / (1 + CNT_CHILDREN), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = AMT_INCOME_TOTAL / (1 + CNT_CHILDREN), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```

### INCOME_RATE_PER_CHILD
```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = AMT_INCOME_TOTAL / ((AMT_CREDIT)*(1 + CNT_CHILDREN^2)), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = AMT_INCOME_TOTAL / ((AMT_CREDIT)*(1 + CNT_CHILDREN^2)), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```
### DAYS_EMPLOYED
```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = DAYS_EMPLOYED, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = DAYS_EMPLOYED, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot1
plot2
```

Wtf is this? Useless values, useless feature.


### DAYS_BIRTH
```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = -DAYS_BIRTH/365.25, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	xlab("Age") +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = -DAYS_BIRTH/365.25, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	xlab("Age") +
	theme_bw()

plot1
plot2
```

### AGE_PRESSURE
```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = (AMT_CREDIT*(-DAYS_BIRTH)/AMT_INCOME_TOTAL), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = (AMT_CREDIT*(-DAYS_BIRTH)/AMT_INCOME_TOTAL), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```

### DAYS_LAST_PHONE_CHANGE
```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = -DAYS_LAST_PHONE_CHANGE, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = -DAYS_LAST_PHONE_CHANGE, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```
### IMPULSIVITY
```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = -DAYS_LAST_PHONE_CHANGE*log10(AMT_INCOME_TOTAL), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = -DAYS_LAST_PHONE_CHANGE*log10(AMT_INCOME_TOTAL), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```

### OWN_CAR_AGE
```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = OWN_CAR_AGE, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = OWN_CAR_AGE, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot1
plot2
```


### IMPULSIVITY_CAR

```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = 365.25*OWN_CAR_AGE*(-DAYS_LAST_PHONE_CHANGE)/AMT_INCOME_TOTAL, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = 365.25*OWN_CAR_AGE*(-DAYS_LAST_PHONE_CHANGE)/AMT_INCOME_TOTAL, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```

### PHONE_TO_BIRTH_RATIO

```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = DAYS_LAST_PHONE_CHANGE / DAYS_BIRTH, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = DAYS_LAST_PHONE_CHANGE / DAYS_BIRTH, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```

### PHONE_TO_EMPLOY_RATIO

```{r}
plot1 <- application_train %>% 
	ggplot(aes(x = DAYS_LAST_PHONE_CHANGE / DAYS_EMPLOYED, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = DAYS_LAST_PHONE_CHANGE / DAYS_EMPLOYED, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	scale_x_log10() +
	theme_bw()

plot1
plot2
```


## External Sources

### EXT_SOURCE_1 
```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = EXT_SOURCE_1, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = EXT_SOURCE_1, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot1
plot2
```

### EXT_SOURCE_2
```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = EXT_SOURCE_2, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = EXT_SOURCE_2, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot1
plot2
```

### EXT_SOURCE_3
```{r}

plot1 <- application_train %>% 
	mutate(EXT_SOURCE_3 = ifelse(EXT_SOURCE_3^2 > 0.75, EXT_SOURCE_1, EXT_SOURCE_3)) %>% 
	ggplot(aes(x = EXT_SOURCE_3, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot2 <- application_train %>% 
	mutate(EXT_SOURCE_3 = ifelse(EXT_SOURCE_3^2 > 0.75, EXT_SOURCE_1, EXT_SOURCE_3)) %>% 
	ggplot(aes(x = EXT_SOURCE_3^2, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	# scale_x_log10() +
	theme_bw()

plot1
plot2
```

### EXT_SOURCE_OPS
```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = (abs(EXT_SOURCE_1-EXT_SOURCE_3)), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	theme_bw()

plot2 <- application_train %>% 
	# mutate(EXT_SOURCE_3 = ifelse(EXT_SOURCE_3^1 > 0.75, EXT_SOURCE_1, EXT_SOURCE_3)) %>% 
	ggplot(aes(x = (abs(EXT_SOURCE_1-EXT_SOURCE_3)), fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill", binwidth = 0.01) +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot1
plot2
```

### EXT_SOURCE_PROD
```{r}

plot1 <- application_train %>% 
	ggplot(aes(x = EXT_SOURCE_1*EXT_SOURCE_2, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	theme_bw()

plot2 <- application_train %>% 
	ggplot(aes(x = EXT_SOURCE_1*EXT_SOURCE_2, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill", binwidth = 0.01) +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot1
plot2
```


### EXT_SOURCE_MEAN
```{r}

plot1 <- application_train %>% 
	mutate(EXT_SOURCE_3 = ifelse(EXT_SOURCE_3^2 > 0.75, EXT_SOURCE_1, EXT_SOURCE_3)) %>% 
	ggplot(aes(x = (EXT_SOURCE_1 + EXT_SOURCE_2 + EXT_SOURCE_3)/3, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "dodge") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Variable Distribution") +
	theme_bw()

plot2 <- application_train %>% 
	mutate(EXT_SOURCE_3 = ifelse(EXT_SOURCE_3^2 > 0.75, EXT_SOURCE_1, EXT_SOURCE_3)) %>% 
	ggplot(aes(x = (EXT_SOURCE_1 + EXT_SOURCE_2 + EXT_SOURCE_3)/3, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot3 <- application_train %>% 
	ggplot(aes(x = ((EXT_SOURCE_1 + EXT_SOURCE_2)/2)^2, fill = as.factor(TARGET))) +
	geom_histogram(aes(y = ..density..), colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Variable Distribution") +
	theme_bw()

plot1
plot2
plot3
```


## Who accompanied the client?

In this plot we can see an unnamed category. This caregory refers to the rest of Type Suites together.

```{r}
application_train <- fread("data/application_train.csv")

df <- application_train %>% 
	na.omit() %>% 
	mutate(NAME_TYPE_SUITE = ifelse(NAME_TYPE_SUITE == "", "Other_C", NAME_TYPE_SUITE)) %>% 
	group_by(NAME_TYPE_SUITE) %>% 
	summarise(n = n()/nrow(application_train %>% na.omit()))

vals <- c(df["n"])[[1]]
val_names <- sprintf("%s (%s)", c("Children", 
																	"Family",
																	"Group of People",
																	"Other_A",
																	"Other_B",
																	"Other_C",
																	"Spouse",
																	"Unaccompanied"), scales::percent(round(vals/sum(vals), 6)))
names(vals) <- val_names

waffle::waffle(round(vals*100), rows = 3, title = "Payers") +
  scale_fill_hp(discrete = TRUE, name = NULL, house = "Ravenclaw")

df <- application_train %>% 
	na.omit() %>% 
	mutate(NAME_TYPE_SUITE = ifelse(NAME_TYPE_SUITE == "", "Other_C", NAME_TYPE_SUITE)) %>% 
	group_by(NAME_TYPE_SUITE, TARGET) %>% 
	summarise(n = n()) %>% 
	arrange(desc(n))

df2 <- df %>% 
	filter(!(NAME_TYPE_SUITE %in% c("Unaccompanied", "Family", "Spouse, partner"))) %>% 
	group_by(TARGET) %>% 
	summarise(n = sum(n)) %>% 
	mutate(NAME_TYPE_SUITE = "Others")

df %>% 
	filter((NAME_TYPE_SUITE %in% c("Unaccompanied", "Family", "Spouse, partner"))) %>% 
	bind_rows(df2) %>% 
		ggplot(aes(x = NAME_TYPE_SUITE, y = log10(log10(n)), fill = as.factor(TARGET))) +
	geom_col(colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Distribution") +
	ylab("Log10(Log10(count)") +
	theme_bw()
	


```
## Types of Loan

- **Rovolving loans** : Arrangement which allows for the loan amount to be withdrawn, repaid, and redrawn again in any manner and any number of times, until the arrangement expires. Credit card loans and overdrafts are revolving loans. Also called evergreen loan

```{r}
application_train <- fread("data/application_train.csv")
	
df <- application_train %>% 
	na.omit() %>% 
	group_by(NAME_CONTRACT_TYPE) %>% 
	summarise(n = n()/nrow(application_train %>% na.omit())) 

vals <- c(df["n"])[[1]]
val_names <- sprintf("%s (%s)", c("Cash Loans", "Revolving Loans"), scales::percent(round(vals/sum(vals), 2)))
names(vals) <- val_names

waffle::waffle(round(vals*100), rows = 5) +
  scale_fill_hp(discrete = TRUE, name = NULL, house = "Hufflepuff")

application_train %>% 
	na.omit() %>% 
	group_by(NAME_CONTRACT_TYPE, TARGET) %>% 
	summarise(n = n()) %>% 
	arrange(desc(n)) %>% 
	ggplot(aes(x = NAME_CONTRACT_TYPE, y = log10(n), fill = as.factor(TARGET))) +
	geom_col(colour = "black", position = "fill") +
	scale_fill_hp(discrete = TRUE, house = "Slytherin", name = "TARGET") +
	ggtitle("Normalised Distribution") +
	theme_bw()
```



## Unbalanced Data: How many people actually paid back the loan?

```{r}
df <- application_train %>% 
	na.omit() %>% 
	group_by(TARGET) %>% 
	summarise(n = n()/nrow(application_train %>% na.omit())) 

vals <- c(df["n"])[[1]]
val_names <- sprintf("%s (%s)", c("Paid", "Did not pay"), scales::percent(round(vals/sum(vals), 2)))
names(vals) <- val_names

waffle::waffle(round(vals*100), rows = 5) +
  scale_fill_hp(discrete = TRUE, name = NULL, direction = -1)
```

### Income Sources


```{r}
application_train <- fread("data/application_train.csv")
	
df <- application_train %>% 
	na.omit() %>% 
	group_by(NAME_INCOME_TYPE) %>% 
	summarise(n = n()/nrow(application_train %>% na.omit())) 

vals <- c(df["n"])[[1]]
val_names <- sprintf("%s (%s)", c("Commercial Associate",
																	"Pensioner",
																	"State Servant",
																	"Working"), scales::percent(round(vals/sum(vals), 2)))
names(vals) <- val_names

waffle::waffle(round(vals*100), rows = 5) +
  scale_fill_hp(discrete = TRUE, name = NULL, house = "Ravenclaw")
```


